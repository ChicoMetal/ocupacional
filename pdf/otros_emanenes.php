<?php//============================================================+// File name   : example_003.php// Begin       : 2008-03-04// Last Update : 2010-08-08//// Description : Example 003 for TCPDF class//               Custom Header and Footer//// Author: Nicola Asuni//// (c) Copyright://               Nicola Asuni//               Tecnick.com LTD//               Manor Coach House, Church Hill//               Aldershot, Hants, GU12 4RQ//               UK//               www.tecnick.com//               info@tecnick.com//============================================================+/** * Creates an example PDF TEST document using TCPDF * @package com.tecnick.tcpdf * @abstract TCPDF - Example: Custom Header and Footer * @author Nicola Asuni * @since 2008-03-04 */require_once('tcpdf/config/lang/eng.php');require_once('tcpdf/tcpdf.php');require 'clases/Db.class.php';require 'clases/Conf.class.php';require 'clases/Conv.class.php';$bd=Db::getInstance();$conv=Conv::getInstance();$codigofact=$_GET['codigo'];$codactividad=$_GET['codactividad'];// Extend the TCPDF class to create custom Header and Footerclass MYPDF extends TCPDF {	public  $filaactual=0;	public $compasig="",$compacate="";	private  $codigofact="",$entroli=0;		function certificadointegral($datos,$datacuestionario,$datosdbrecomendaciones, $codigofact){		$style6 = array('width' => 0.1, 'cap' => 'butt', 'join' => 'miter', 'dash' => 0, 'color' => array(0, 0, 0));		$tam1=5;		$li=35;		$this->cabecera($datos,4, $codigofact);		$this->SetFont('helvetica', '', 10);		$this->SetFillColor(255, 255, 255);		$li=$li+8;		$this->MultiCell(200, 5,"TIPO:  ".strtoupper($datos[0]['tipo'])."\n", 0, 'J', 1, 0, 5, $li, true);		$li=$li+$tam1;		$this->RoundedRect(4, $li, 200,$tam1 , 3.50, '0000',null,$style6);		$this->MultiCell(200, 5,"Fecha:".strtoupper($datos[0]['fecha']). "       Empresa: ".strtoupper($datos[0]['razonsocial'])."\n", 0, 'J', 1, 0, 5, $li, true);		$li=$li+$tam1;		$this->RoundedRect(4, $li, 200,$tam1 , 3.50, '0000',null,$style6);		$this->MultiCell(200, 5,"Nombres Y Apellidos: ".strtoupper($datos[0]['nombres'])." ".strtoupper($datos[0]['apellidos'])." Cedula: ".strtoupper($datos[0]['identificacion'])."\n", 0, 'J', 1, 0, 5, $li, true);		$li=$li+$tam1;		$this->RoundedRect(4, $li, 200,$tam1 , 3.50, '0000',null,$style6);		$this->MultiCell(200, 5,"Edad: ".strtoupper($datos[0]['edad'])." años  Cargo: ".strtoupper($datos[0]['cargo'])."\n", 0, 'J', 1, 0, 5, $li, true);		$this->SetFont('helvetica', 'B', 10);		$li=$li+$tam1+3;		$this->buscaraudiometria($datos,$datacuestionario,$li);	 }	function buscaraudiometria($datos,$datacuestionario,$inicio){	$style6 = array('width' => 0.1, 'cap' => 'butt', 'join' => 'miter', 'dash' => 0, 'color' => array(0, 0, 0));	$tam1=4;	$li=$inicio;	// $this->SetFont('helvetica', 'B', 10);	//$li=$li+$tam1;	//$this->MultiCell(200, 5,"RECOMENDACIONES LABORALES\n", 0, 'C', 1, 0, 5, $li, true);	$li=$li+$tam1+3;	$this->SetFont('helvetica', '', 10);	$i=0;	$tamori= $li;	$aux=$li;	$enx=5;	$entro=0;	$cambiodelinea=0;	$mayoraux=0;	$codpadre="";	$linea=0;	$span=10;	$entror=false;		if($datacuestionario!="")//si no esta vacio	foreach ($datacuestionario as  $data){		if($codpadre!=$data['codpadre']){			/*if($linea==0){				$linea=1;				$span=5;				$li=$this->addli($aux,$tam1);			}else{				$span=100;				$linea=0;				$aux=$li;			}*/			$this->SetFont('helvetica', 'B',6);			$this->MultiCell(100, 5,$data['nompadre'], 0, 'L', 1, 0, $span, $aux, true);				if($data['nompadre']=="RECOMENDACIONES"){				$entror=true;			}			$aux=$this->addli($aux,$tam1);			if(strlen($data['nompadre'])>=35){				   $aux=$this->addli($aux,$tam1);			}		}		$this->SetFont('helvetica', '', 6);		$codpadre=$data['codpadre'];		$codpregunta="";		if($data["tipo"]=="text"){			$this->MultiCell(100, 5,"".$data['pregunta']."\n", 0, 'L', 1, 0, $span, $aux, true);								//echo "</td></tr><tr><td colspan='2'>".$data['pregunta']."</td></tr><tr><td>";			$campoval=array_filter(explode('<div class="respuestas" >',$data['campos']));			$campovalres=array_filter(explode('<div class="respuestas" >',$data['respuestas']));			$aux=$this->addli($aux,$tam1);			$cont=1;			$acumuladorcampos="";			$tamacu=0;			foreach ($campoval as $campo) {				$campo=str_replace("</div>", "", $campo);				$campovalres[$cont]=str_replace("</div>", "", $campovalres[$cont]);				$acumuladorcampos.=" ".$campo.": ".$campovalres[$cont];								$tamacu+=strlen($campo.": ".$campovalres[$cont]);				$cont++;			}						$this->MultiCell(90, 10,$acumuladorcampos, 0, 'L', 1, 0, $span, $aux, true);				$aux=$this->addli($aux,$tam1);						if(strlen($acumuladorcampos)>=30){				   $aux=$this->addli($aux,$tam1);				   //$this->MultiCell(90, 10,$aux, 0, 'J', 1, 0, $span, $aux, true);				}			if(strlen($acumuladorcampos)>=60){				   $aux=$this->addli($aux,$tam1);				   //$this->MultiCell(90, 10,$aux, 0, 'J', 1, 0, $span, $aux, true);				}				if(strlen($acumuladorcampos)>=90){				   $aux=$this->addli($aux,$tam1);				   //$this->MultiCell(90, 10,$aux, 0, 'J', 1, 0, $span, $aux, true);				}						}else if($data["tipo"]=="radio"){			$cont=1;			$campovalres=array_filter(explode('<div class="respuestas" >',$data['respuestas']));			$campovalres[$cont]=str_replace("</div>", "", $campovalres[$cont]);			$campovalres[$cont]=str_replace("</div>", "", $campovalres[$cont]);			$this->MultiCell(90, 5,$data['pregunta'].": ".$campovalres[$cont], 0, 'L', 1, 0, $span, $aux, true);				$cont++;			$aux=$this->addli($aux,$tam1);		}else if($data["tipo"]=="select"){			$cont=1;			$campovalres=array_filter(explode('<div class="respuestas" >',$data['respuestas']));			$campovalres[$cont]=str_replace("</div>", "", $campovalres[$cont]);			$campovalres[$cont]=str_replace("</div>", "", $campovalres[$cont]);			$this->MultiCell(90, 5,$data['pregunta'].": ".$campovalres[$cont], 0, 'L', 1, 0, $span, $aux, true);				$cont++;			$aux=$this->addli($aux,$tam1);		}else if($data["tipo"]=="checkbox"){			$this->MultiCell(100, 5,"".$data['pregunta']."\n", 0, 'J', 1, 0, $span, $aux, true);				//$campoval=array_filter(explode('<div class="respuestas" >',$data['campos']));			$campovalres=array_filter(explode('<div class="respuestas" >',$data['respuestas']));			$cont=1;			$acumuladorcampos="";			foreach ($campovalres as $campo) {				$campo=str_replace("</div>", "", $campo);				$campovalres[$cont]=str_replace("</div>", "", $campovalres[$cont]);				$acumuladorcampos.=$campovalres[$cont].", ";				$cont++;			}			$this->MultiCell(90, 10,$acumuladorcampos, 0, 'L', 1, 0, $span, $aux, true);				$aux=$this->addli($aux,$tam1);            $cont++;	          		} 		    						}	if($entror==false){		$this->MultiCell(100, 5,"RECOMENDACIONES", 0, 'L', 1, 0, $span, $aux, true);									}			$li=$this->addli($aux,40);				$this->SetFont('helvetica', '', 7);		$this->Line( 5,$li ,80,$li);		$this->MultiCell(80, 5,"<B>Edison Martinez Diaz / R.M. 428 </B> <br> C.C 92504399<br>LICENCIA S.O No. 058".".\n", 0, 'C', 1, 0, 5, $li, true,0,true);			$this->Line( 110,$li ,185,$li);		$this->MultiCell(80, 5,"<B>Firma trabajador </B>"."\n", 0, 'C', 1, 0, 110, $li, true,0,true);			$image_file = "../fotos/firmas/".$datos[0]['firma'];		//echo  $image_file ;		$this->Image($image_file,120, $li-16, 50, 15, 'JPG', '', 'T', false, 100, '', false, false, 0, false, false, false);		$image_file = "firmadigital.jpg";		$this->Image($image_file,20, $li-16, 50, 15, 'JPG', '', 'T', false, 100, '', false, false, 0, false, false, false);			}	function cabecera($datos,$pos, $codigofact){		$this->SetFillColor(255, 255, 255);		$image_file = "cabecera1.jpg";		$this->Image($image_file,5, $pos, 75, '', 'JPG', '', 'T', false, 100, '', false, false, 0, false, false, false);		$this->SetFont('helvetica', 'B', 7);		$texto1=$this->remplazarcaracteres(" Licencia de Salud Ocupacional Reseolucion No. 0668 07/03/2007 \nCodigo de prestador de servicio de salud No 700010120303\nMinproteccionsocial Resol. No 0197 del 18 de febrero de 2010\nVigilidado Supersalud ");		$this->MultiCell(120, 20,$texto1, 0, 'C', 1, 0, 105, $pos, true);		$pos=$pos+14;		//$image_file = "../fotos/firmas/".$datos[0]['foto'];		//$this->Image($image_file,170, $pos, 20, '', 'JPG', '', 'T', false, 100, '', false, false, 0, false, false, false);		$this->MultiCell(120, 5,"Historia:".$codigofact, 0, 'C', 1, 0,125, $pos, true);		$this->SetFont('helvetica', '', 9);		$texto1=$this->remplazarcaracteres(" Carrera 27 No 12-115 : Tel 2740472 : Cels 311 6630503 - 301 4447013 SINCELEJO, COL.");		$this->MultiCell(200, 5,$texto1, 0, 'C', 1, 0, 5, $pos, true,0,true);		$this->SetFont('helvetica', 'B', 12);		$pos=$pos+6;		$texto1=$this->remplazarcaracteres("HISTORIA CLINICA");		$this->MultiCell(200, 5,$texto1, 0, 'C', 1, 0, 5, $pos, true,0,true);		$pos=$pos+5;		$texto1=$this->remplazarcaracteres(strtoupper($datos[0]['nomactividad']));		$this->MultiCell(200, 5,$texto1, 0, 'C', 1, 0, 5, $pos, true,0,true);		$pos=$pos+5;		//$texto1=$this->remplazarcaracteres(" SISTEMA DE VIGILANCIA EPIDEMIOLOGICA CONSERVACION AUDITIVA");		//$this->MultiCell(200, 5,$texto1, 0, 'C', 1, 0, 5, $pos, true,0,true);		//$this->MultiCell(120, 5,$this->codigofact, 0, 'C', 1, 0,50, 319, true);		}		function addli($li,$aumento,$head=0){			if($li>300){				$this->addpage();				$li=35;			}						$li=$li+$aumento;			return $li;		}	//Page header	function remplazarcaracteres($caracter){		return $caracter;		$caracter=str_replace("á","Á",$caracter);		$caracter=str_replace("é","É",$caracter);		$caracter=str_replace("í","Í",$caracter);		$caracter=str_replace("ó","Ó",$caracter);		$caracter=str_replace("ú","Ú",$caracter);		$caracter=str_replace("ñ","Ñ",$caracter);		//return $caracter;	}	function tabladedatos($datosbd,$datosaptitud,$datosdbrecomendaciones,$codigofact){		$epg="";		$this->addpage();		$this->certificadointegral($datosbd,$datosaptitud,$datosdbrecomendaciones, $codigofact);				}//Pie de página	// Page footer	public function Footer() {		//Piecera		/*		$this->SetFont('helvetica', '', 10);		$this->SetFillColor(255, 255, 255);		$this->RoundedRect(4, 239, 150, 20, 3.50, '1111');		$this->MultiCell(55, 5,"Observaciones", 0, 'L', 1, 100, 10, 240, true);		$this->MultiCell(55, 5,"Escala de Desempeño", 0, 'L', 1, 100, 100, 240, true);		// Position at 15 mm from bottom		$this->SetY(-15);		// Set font		$this->SetFont('helvetica', 'I', 8);*/		// Page number		$this->SetY(-15);		$this->SetFont('helvetica', 'I', 8);	$this->Cell(0, 10,"Pag. ".$this->PageNo()."", 0,0,'C');	}}// create new PDF document$pdf = new MYPDF(PDF_PAGE_ORIENTATION, PDF_UNIT, "A4_LONG", true, 'UTF-8', false);// set document information$pdf->SetCreator(PDF_CREATOR);$pdf->setLanguageArray($l);// set default header data// set header and footer fonts$pdf->setHeaderFont(Array(PDF_FONT_NAME_MAIN, '', PDF_FONT_SIZE_MAIN));$pdf->setFooterFont(Array(PDF_FONT_NAME_DATA, '', PDF_FONT_SIZE_DATA));// set default monospaced font$pdf->SetDefaultMonospacedFont(PDF_FONT_MONOSPACED);//set margins$pdf->SetMargins(PDF_MARGIN_LEFT, PDF_MARGIN_TOP, PDF_MARGIN_RIGHT);$pdf->SetHeaderMargin(PDF_MARGIN_HEADER);$pdf->SetFooterMargin(PDF_MARGIN_FOOTER);//set auto page breaks$pdf->SetAutoPageBreak(TRUE, PDF_MARGIN_BOTTOM);//set image scale factor$pdf->setImageScale(PDF_IMAGE_SCALE_RATIO);//set some language-dependent strings$pdf->setLanguageArray($l);// ---------------------------------------------------------// set font$pdf->SetFont('times', 'BI', 12);$consulta = "SELECT  				t.nombre as tipo,				h.fecha as fecha, 				e.razonsocial, 				h.cargo as cargo,				p.nombres,				p.apellidos,				p.identificacion,				CASE				WHEN (MONTH(p.fechanacimiento) < MONTH(current_date)) THEN YEAR(current_date) - YEAR(p.fechanacimiento)				WHEN (MONTH(p.fechanacimiento) = MONTH(current_date)) AND (DAY(p.fechanacimiento) <= DAY(current_date)) THEN YEAR(current_date) - YEAR(p.fechanacimiento)				ELSE (YEAR(current_date) - YEAR(p.fechanacimiento)) - 1				END AS edad,				a.nombre as nomactividad,				p.foto as foto,				p.firma as firma			from 				historias_otros h,				orden_actividades ord,				actividaescontratadas ac,				detalle_orden_actividades det,				actividades a,				tipo_examenes t,				pacientes p,				empresas e							where 				h.codorden=ord.codigo and				h.tipo=t.codigo and 				ord.codcontrato=ac.codigo and				ord.codpaciente=p.codigo and				ac.codempresa=e.codigo and				det.codorden_actividad=ord.codigo and				det.codactividad=a.codigo and				h.codigo='$codigofact' and 				a.codigo='$codactividad'				 " ;//echo $consulta;$result = $bd->ejecutar($consulta);$datosdb="";$datosdbactitud="";$datacuestionario="";while($fila= $bd->obtener_fila($result,0)){	$datosdb[]=$fila;} //while//Buscar preguntas audiometrias$consultaref = "SELECT                 hd.respuestas,                hd.observacion resobservacion,                 ah.codigo as codpregunta,                ah.pregunta,                ah.tipo,                ah.campos,                ah.valorpordefecto,                ah.observacion preobservacion,                ah.codigo as codpregunta,                ap.codigo as codpadre,                ap.nombre as nompadre,                a.nombre as nomactividad              from                 historias_otros h,                historias_otros_detalles hd,                actividades_preguntas ah,                actividades_nomformularios ap,                actividadesdelaempresa ade,                actividades a              where                hd.codhistoriaotros=h.codigo and                hd.codpregunta=ah.codigo and                ah.codnombreformulario=ap.codigo and                ade.codigo=ap.codactdelaempresa and                 ade.codactividad=a.codigo and                h.codigo ='$codigofact' and                 a.codigo='$codactividad' order by ap.orden, ah.orden,ap.codigo,ah.codigo				";//echo $consultaref;$resultref = $bd->ejecutar($consultaref);$datosdbactitud="";while ($filaref= $bd->obtener_fila($resultref,0)){	$datacuestionario[]=$filaref;}if($datosdb!=""){	$pdf->tabladedatos($datosdb,$datacuestionario,$datosdbactitud, $codigofact);}else{	echo "No hay datos para esta historia $codigofact";	exit;}// set some text to print// print a block of text using Write()$pdf->Write($h=0, "", $link='', $fill=0, $align='C', $ln=true, $stretch=0, $firstline=false, $firstblock=false, $maxh=0);// ---------------------------------------------------------//Close and output PDF document$pdf->Output('formatos.pdf', 'I');//============================================================+// END OF FILE//============================================================+?>