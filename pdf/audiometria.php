<?php//============================================================+// File name   : example_003.php// Begin       : 2008-03-04// Last Update : 2010-08-08//// Description : Example 003 for TCPDF class//               Custom Header and Footer//// Author: Nicola Asuni//// (c) Copyright://               Nicola Asuni//               Tecnick.com LTD//               Manor Coach House, Church Hill//               Aldershot, Hants, GU12 4RQ//               UK//               www.tecnick.com//               info@tecnick.com//============================================================+/** * Creates an example PDF TEST document using TCPDF * @package com.tecnick.tcpdf * @abstract TCPDF - Example: Custom Header and Footer * @author Nicola Asuni * @since 2008-03-04 */require_once('tcpdf/config/lang/eng.php');require_once('tcpdf/tcpdf.php');require 'clases/Db.class.php';require 'clases/Conf.class.php';require 'clases/Conv.class.php';$bd=Db::getInstance();$conv=Conv::getInstance();$codigofact=$_GET['codigo'];// Extend the TCPDF class to create custom Header and Footerclass MYPDF extends TCPDF {	public  $filaactual=0;	public $compasig="",$compacate="";	private  $codigofact="",$entroli=0;		 function certificadointegral($datos,$datosdbaudiometria,$datosdbrecomendaciones, $codigofact)	{	$style6 = array('width' => 0.1, 'cap' => 'butt', 'join' => 'miter', 'dash' => 0, 'color' => array(0, 0, 0));		$tam1=5;	 $li=35;     $this->cabecera($datos,4, $codigofact);     $this->SetFont('helvetica', '', 10);     $this->SetFillColor(255, 255, 255); 	 $li=$li+8;     $this->MultiCell(200, 5,"tipo ".strtoupper($datos[0]['tipo'])."\n", 0, 'J', 1, 0, 5, $li, true);	 $li=$li+$tam1;	 	 $this->RoundedRect(4, $li, 200,$tam1 , 3.50, '0000',null,$style6);	 	 $this->MultiCell(200, 5,"Fecha:".strtoupper($datos[0]['fecha']). "       Empresa: ".strtoupper($datos[0]['razonsocial'])."\n", 0, 'J', 1, 0, 5, $li, true);		 $li=$li+$tam1;	  $this->RoundedRect(4, $li, 200,$tam1 , 3.50, '0000',null,$style6);	 $this->MultiCell(200, 5,"Nombres Y Apellidos: ".strtoupper($datos[0]['nombres'])." ".strtoupper($datos[0]['apellidos'])." Cedula: ".strtoupper($datos[0]['identificacion'])."\n", 0, 'J', 1, 0, 5, $li, true);	 $li=$li+$tam1;	  $this->RoundedRect(4, $li, 200,$tam1 , 3.50, '0000',null,$style6);	 $this->MultiCell(200, 5,"Edad: ".strtoupper($datos[0]['edad'])." años  Cargo actual/aspira: ".strtoupper($datos[0]['cargo_atual'])."\n", 0, 'J', 1, 0, 5, $li, true);	  $this->SetFont('helvetica', 'B', 10);	 $li=$li+$tam1+3;	 	 $this->buscaraudiometria($datos,$datosdbaudiometria,$li);	 }	function buscaraudiometria($datos,$datosdbaudiometria,$inicio){$style6 = array('width' => 0.1, 'cap' => 'butt', 'join' => 'miter', 'dash' => 0, 'color' => array(0, 0, 0));		$tam1=4;       $li=$inicio;	  	  // $this->SetFont('helvetica', 'B', 10);//$li=$li+$tam1;	 //$this->MultiCell(200, 5,"RECOMENDACIONES LABORALES\n", 0, 'C', 1, 0, 5, $li, true);	 $li=$li+$tam1+3;	 $this->SetFont('helvetica', '', 10);	 $i=0;	 	 $tamori= $li;	 $aux=$li;	 $enx=5;	 $entro=0;	 $cambiodelinea=0;	 $mayoraux=0;	 for ($i=1;$i<=8;$i++)	 {	 		if($datosdbaudiometria!="")//si no esta vacio					foreach ($datosdbaudiometria as  $datosac) 			{															    	if($datosac['codigo']==$i)					{						if($entro==0)						{						$entro=1;						 $this->SetFont('helvetica', 'B', 10);						$this->MultiCell(100, 5,"".$datosac['pregunta']."\n", 0, 'J', 1, 0, $enx, $aux, true);							 $aux=$aux+$tam1+2;						 $cambiodelinea=$cambiodelinea+1;						 						  if(strlen($datosac['pregunta'])>=35)					  {					   $aux=$aux+$tam1;					  }						  						}						$this->SetFont('helvetica', '', 7);					  $this->MultiCell(100, 5,"".ucfirst(strtolower ($datosac['respuesta'])).".\n", 0, 'L', 1, 0, $enx, $aux, true);						  if(strlen($datosac['respuesta'])>=43)					  {					   $aux=$aux+$tam1;					  }					  $aux=$aux+$tam1;					}					else					{						if($entro==1)						{																			if($aux>$mayoraux)							{							  $mayoraux=$aux;							}													$aux=$li;						$enx=$enx+100;						$entro=0;						}								}																}			if( $cambiodelinea%2==0 && $cambiodelinea!=0 )					{					$tam=  $mayoraux- $li;					$this->RoundedRect(4, $li, 200,$tam , 3.50, '0000',null,$style6);										 					$this->Line(106, $li, 106,$mayoraux);											$aux=$mayoraux;						$li=$mayoraux;						$enx=5;						$entro=0;					}	 }	if( $cambiodelinea!=0)     {                     $tam=  $mayoraux- $li;					$this->RoundedRect(4, $li, 200,$tam , 3.50, '0000',null,$style6);										$this->Line(106, $li, 106,$mayoraux);										      	  $li=$mayoraux+4;	}					$this->SetFont('helvetica', '', 7);			$this->MultiCell(200, 5,"<b>Consentimiento informado:</b> Autorizo al profesional abajo mencionado a que se me realice de manera voluntaria el examen medico ocupacional, examenes complementarios y dejo constancia que tuve la oportunidad de manifestar mi consentimiento para la realizacion del examen medico ocupacional y/o examenes complementarios, a partir de la informacion recibida por el profsional abajo mencionado. Certifico que la informacion que he suministrado es verdadera, completa, que no omiti ningun dato relevante, que los datos consignado fueron los aportados por mi al momento del examen y acepto el manejo de condicionalidad que SOIE IPS Ltda. De a la misma. Autorizo que suministro la informacion necesaria a la empresa contrante o entidades contempladas en la legislacion para el cumplimiento del programa de salud ocupacional, me entregaron copia de los examenes realizados.".".\n", 0, 'J', 1, 0, 5, $li, true,0,true);		$li=$li+40;		 $this->SetFont('helvetica', '', 10);	 	 $this->Line( 5,$li ,80,$li);	$this->MultiCell(80, 5,"<B>Edison Martinez Diaz / R.M. 428 </B> <br> C.C 92504399<br>LICENCIA S.O No. 058".".\n", 0, 'C', 1, 0, 5, $li, true,0,true);			 $this->Line( 110,$li ,185,$li);	$this->MultiCell(80, 5,"<B>Firma trabajador </B>"."\n", 0, 'C', 1, 0, 110, $li, true,0,true);			 $image_file = "../fotos/firmas/".$datos[0]['firma'];      //echo  $image_file ;         $this->Image($image_file,120, $li-16, 50, 15, 'JPG', '', 'T', false, 100, '', false, false, 0, false, false, false);				 $image_file = "firmamedico.jpg";                      $this->Image($image_file,20, $li-16, 50, 15, 'JPG', '', 'T', false, 100, '', false, false, 0, false, false, false);					}	  function cabecera($datos,$pos, $codigofact){				         $this->SetFillColor(255, 255, 255);		 $image_file = "cabecera1.jpg";                      $this->Image($image_file,5, $pos, 75, '', 'JPG', '', 'T', false, 100, '', false, false, 0, false, false, false);    	$this->SetFont('helvetica', 'B', 7);				   $texto1=$this->remplazarcaracteres(" Licencia de Salud Ocupacional Reseolucion No. 0668 07/03/2007 \nCodigo de prestador de servicio de salud No 700010120303\nMinproteccionsocial Resol. No 0197 del 18 de febrero de 2010\nVigilidado Supersalud ");			$this->MultiCell(120, 20,$texto1, 0, 'C', 1, 0, 105, $pos, true);			$pos=$pos+14;    					 $image_file = "../fotos/firmas/".$datos[0]['foto'];                      $this->Image($image_file,170, $pos, 20, '', 'JPG', '', 'T', false, 100, '', false, false, 0, false, false, false);					$this->MultiCell(120, 5,"Historia:".$codigofact, 0, 'C', 1, 0,125, $pos, true);        	$this->SetFont('helvetica', '', 9);		            $texto1=$this->remplazarcaracteres(" Carrera 27 No 12-115 : Tel 2740472 : Cels 311 6630503 - 301 4447013 SINCELEJO, COL.");			$this->MultiCell(200, 5,$texto1, 0, 'C', 1, 0, 5, $pos, true,0,true);          		  $this->SetFont('helvetica', 'B', 12);           $pos=$pos+6;            $texto1=$this->remplazarcaracteres("HISTORIA CLINICA");			$this->MultiCell(200, 5,$texto1, 0, 'C', 1, 0, 5, $pos, true,0,true);$pos=$pos+5;            $texto1=$this->remplazarcaracteres(" AUDIOMETRIA OCUPACIONAL");			$this->MultiCell(200, 5,$texto1, 0, 'C', 1, 0, 5, $pos, true,0,true);		$pos=$pos+5;            $texto1=$this->remplazarcaracteres(" SISTEMA DE VIGILANCIA EPIDEMIOLOGICA CONSERVACION AUDITIVA");			$this->MultiCell(200, 5,$texto1, 0, 'C', 1, 0, 5, $pos, true,0,true);//$this->MultiCell(120, 5,$this->codigofact, 0, 'C', 1, 0,50, 319, true);		}	//Page header	public function Header() {	} function lineasVerticales(){}	function remplazarcaracteres($caracter){		$caracter=str_replace("á","Á",$caracter);		$caracter=str_replace("é","É",$caracter);		$caracter=str_replace("í","Í",$caracter);		$caracter=str_replace("ó","Ó",$caracter);		$caracter=str_replace("ú","Ú",$caracter);		$caracter=str_replace("ñ","Ñ",$caracter);		return $caracter;	}function tabladedatos($datosbd,$datosaptitud,$datosdbrecomendaciones,$codigofact){	$epg="";					$this->addpage();				$this->certificadointegral($datosbd,$datosaptitud,$datosdbrecomendaciones, $codigofact);							 	}//Pie de página	// Page footer	public function Footer() {		//Piecera		/*		$this->SetFont('helvetica', '', 10);		$this->SetFillColor(255, 255, 255);		$this->RoundedRect(4, 239, 150, 20, 3.50, '1111');		$this->MultiCell(55, 5,"Observaciones", 0, 'L', 1, 100, 10, 240, true);		$this->MultiCell(55, 5,"Escala de Desempeño", 0, 'L', 1, 100, 100, 240, true);		// Position at 15 mm from bottom		$this->SetY(-15);		// Set font		$this->SetFont('helvetica', 'I', 8);*/		// Page number		$this->SetY(-15);		$this->SetFont('helvetica', 'I', 8);	$this->Cell(0, 10,"Pag. ".$this->PageNo()."", 0,0,'C');	}}// create new PDF document$pdf = new MYPDF(PDF_PAGE_ORIENTATION, PDF_UNIT, "A4_LONG", true, 'UTF-8', false);// set document information$pdf->SetCreator(PDF_CREATOR);$pdf->setLanguageArray($l);// set default header data$pdf->SetHeaderData(PDF_HEADER_LOGO, PDF_HEADER_LOGO_WIDTH, PDF_HEADER_TITLE, PDF_HEADER_STRING);// set header and footer fonts$pdf->setHeaderFont(Array(PDF_FONT_NAME_MAIN, '', PDF_FONT_SIZE_MAIN));$pdf->setFooterFont(Array(PDF_FONT_NAME_DATA, '', PDF_FONT_SIZE_DATA));// set default monospaced font$pdf->SetDefaultMonospacedFont(PDF_FONT_MONOSPACED);//set margins$pdf->SetMargins(PDF_MARGIN_LEFT, PDF_MARGIN_TOP, PDF_MARGIN_RIGHT);$pdf->SetHeaderMargin(PDF_MARGIN_HEADER);$pdf->SetFooterMargin(PDF_MARGIN_FOOTER);//set auto page breaks$pdf->SetAutoPageBreak(TRUE, PDF_MARGIN_BOTTOM);//set image scale factor$pdf->setImageScale(PDF_IMAGE_SCALE_RATIO);//set some language-dependent strings$pdf->setLanguageArray($l);// ---------------------------------------------------------// set font$pdf->SetFont('times', 'BI', 12);$consulta = "	select  	tipoex.nombre as tipo, h.fecha as fecha,  emp.razonsocial,  h.enmision as enmision, pac.nombres, pac.apellidos, pac.identificacion, CASEWHEN (MONTH(pac.fechanacimiento) < MONTH(current_date)) THEN YEAR(current_date) - YEAR(pac.fechanacimiento)WHEN (MONTH(pac.fechanacimiento) = MONTH(current_date)) AND (DAY(pac.fechanacimiento) <= DAY(current_date)) THEN YEAR(current_date) - YEAR(pac.fechanacimiento)ELSE (YEAR(current_date) - YEAR(pac.fechanacimiento)) - 1END AS edad,cargo.cargo_atual, pac.foto as foto, pac.firma as firma from orden_actividades ord,historias h,historias_tipo_examenes tipo,tipo_examenes tipoex,historias_paciente hp,pacientes pac,actividaescontratadas contrato,empresas emp,historias_informacion_ocupacional cargowhere h.codorden=ord.codigo andh.paciente=pac.codigo andh.codigo=hp.codhistoria andtipo.codhistoria=h.codigo and tipoex.codigo=tipo.codexamen andord.codcontrato=contrato.codigo and emp.codigo=contrato.codempresa andh.codigo=cargo.codhistoria andh.codigo=$codigofact";//echo $consulta;$result = $bd->ejecutar($consulta);$datosdb="";$datosdbactitud="";$datosdbaudiometria="";while($fila= $bd->obtener_fila($result,0)){$datosdb[]=array(                'tipo'          =>$fila['tipo'],                                'fecha'             =>$fila['fecha'],                                'razonsocial'           =>$fila['razonsocial'],                                'enmision'           =>$fila['enmision'],                                'nombres'              =>$fila['nombres'],                                'apellidos'            =>$fila['apellidos'],                                'identificacion'         =>$fila['identificacion'],                                'edad'                =>$fila['edad'],                                'cargo_atual'                 =>$fila['cargo_atual'],                               								'foto'                     =>$fila['foto'],								'firma'                     =>$fila['firma'],                                     			 );} //while//Buscar preguntas audiometrias$consultaref = "			select au.codigo as codigo, au.nombre as pregunta,c.nombre as respuestafromhistorias h,historias_audiometria hc,detallesdeaudiometrias c,audiometrias auwhereh.codigo=hc.codhistoria andc.codigo=hc.codaudiometria andau.codigo=c.codaudiometria andh.codigo=".$codigofact." order by au.codigo";$resultref = $bd->ejecutar($consultaref);$datosdbactitud="";while ($filaref= $bd->obtener_fila($resultref,0)){	$datosdbaudiometria[]=array(	'pregunta'=>$filaref['pregunta'],	'respuesta'=>$filaref['respuesta'],	'codigo'=>$filaref['codigo'],			);}/*$consultaref = "			select re.nombre as rgeneral, codrecomendaciones_laborales as codigo, c.nombre as recomendacionfrom historias h,historias_recomendaciones_laborales hc,detallesderecomendaciones_laborales c,recomendaciones_laborales rewherere.codigo=c.codrecomendaciones_laborales andh.codigo=hc.codhistoria andc.codigo=hc.codrecomendacion andh.codigo=".$codigofact." order  by codrecomendaciones_laborales";$resultref = $bd->ejecutar($consultaref);$datosdbrecomendaciones="";while ($filaref= $bd->obtener_fila($resultref,0)){	$datosdbrecomendaciones[]=array(						'recomendacion'=>$filaref['recomendacion'],						'codigo'=>$filaref['codigo'],						'rgeneral'=>$filaref['rgeneral']							);}*/if($datosdb!=""){	$pdf->tabladedatos($datosdb,$datosdbaudiometria,$datosdbactitud, $codigofact);}else{	echo "No hay datos para esta historia $codigofact";	exit;}// set some text to print// print a block of text using Write()$pdf->Write($h=0, "", $link='', $fill=0, $align='C', $ln=true, $stretch=0, $firstline=false, $firstblock=false, $maxh=0);// ---------------------------------------------------------//Close and output PDF document$pdf->Output('formatos.pdf', 'I');//============================================================+// END OF FILE//============================================================+?>